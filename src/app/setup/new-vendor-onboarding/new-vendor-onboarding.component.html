<section>
    <div class="row">
        <div class="col-12">

            <!-- Header -->
            <div class="row">
                <div class="col-md-12" style="margin-top: -0.25rem;">
                    <h4 class="heading">
                        {{ mode === 'Edit' ? 'Edit Vendor Onboarding Setup' : 'Create Vendor Onboarding Setup' }}
                    </h4>
                </div>
            </div>

            <!-- Action Pane -->
            <div class="card cstm-ui-card sticky-toolbar" [class.sticky]="isToolbarSticky">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-lg cstm-ui-table-btn mr-1" type="button" (click)="homePage()">
                            <i class="ft-arrow-left"></i>
                        </button>
                        <span class="vl"></span>
                        <button type="submit" class="btn btn-sm cstm-ui-table-btn"
                            [disabled]="vendorOnboardingForm.invalid || receiverRows.length === 0"
                            *ngIf="mode !== 'Edit'" (click)="submitForm()">
                            <i class="ft-plus"></i><label class="ml-1 mt-1">Save</label>
                        </button>
                        <button
                            [disabled]="mode !== 'Edit' || vendorOnboardingForm.invalid || receiverRows.length === 0"
                            type="reset" class="btn btn-sm cstm-ui-table-btn" (click)="updateForm()">
                            <i class="ft-edit"></i><label class="ml-1 mt-1">{{ mode === 'Edit' ? 'Update' : 'Edit'
                                }}</label>
                        </button>
                        <button [disabled]="mode !== 'Edit'" type="reset" class="btn btn-sm cstm-ui-table-btn">
                            <i class="ft-trash"></i><label class="ml-1 mt-1">Delete</label>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="card sticky-toolbar-target">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ft-user-plus mr-1"></i>
                        Add Users from Different Entities and Roles
                    </h5>
                </div>
                <div class="card-body">
                    <form [formGroup]="vendorOnboardingForm" (ngSubmit)="submitForm()">
                        <div class="form-row">

                            <!-- Setup Name -->
                            <div class="col-lg-4 mb-2">
                                <label>Setup Name</label>
                                <input type="text" class="form-control custom-input" formControlName="SetupName"
                                    placeholder="Setup Name" required>
                                <div *ngIf="vendorOnboardingForm.get('SetupName')?.invalid && vendorOnboardingForm.get('SetupName')?.touched"
                                    class="text-danger small">
                                    Setup Name is required
                                </div>
                            </div>

                            <!-- Select Entity -->
                            <div class="col-lg-4 mb-2">
                                <div class="form-group mb-2">
                                    <label>Select Entity</label>
                                    <ng-select class="custom-style" [items]="entitiesList" bindLabel="name"
                                        bindValue="id" [searchable]="true" placeholder="Select Entity"
                                        formControlName="entities" (change)="onEntitySelected($event)">
                                    </ng-select>
                                    <div *ngIf="vendorOnboardingForm.get('entities')?.invalid && vendorOnboardingForm.get('entities')?.touched"
                                        class="text-danger small">
                                        Entity is required
                                    </div>
                                </div>
                            </div>

                            <!-- Roles -->
                            <div class="col-lg-4 mb-2">
                                <label>Roles</label>
                                <ng-select [items]="roles" bindLabel="name" bindValue="id" placeholder="Select Roles"
                                    formControlName="Roles" (change)="onRoleSelected($event)">
                                </ng-select>
                                <div *ngIf="vendorOnboardingForm.get('Roles')?.invalid && vendorOnboardingForm.get('Roles')?.touched"
                                    class="text-danger small">
                                    Role is required
                                </div>
                            </div>

                            <!-- Request Receiver(s) -->
                            <div class="col-lg-6 mb-2">
                                <div class="form-group mb-2">
                                    <label>Select Receivers to Add</label>
                                    <ng-select class="custom-style" [items]="filteredReceivers" bindLabel="userName"
                                        bindValue="userId" [multiple]="true" [searchable]="true"
                                        placeholder="Select Receivers" formControlName="Receivers">
                                    </ng-select>
                                    <!-- <div class="text-info small mt-1">
                                        Currently selected: {{ vendorOnboardingForm.get('Receivers')?.value?.length || 0 }} user(s)
                                    </div>
                                    <div *ngIf="filteredReceivers.length === 0 && vendorOnboardingForm.get('entities')?.value && vendorOnboardingForm.get('Roles')?.value" 
                                         class="text-info small">
                                        No receivers found for selected entity and role
                                    </div>
                                    <div *ngIf="!vendorOnboardingForm.get('entities')?.value || !vendorOnboardingForm.get('Roles')?.value" 
                                         class="text-info small">
                                        Please select Entity and Role to see available receivers
                                    </div> -->
                                </div>
                            </div>

                            <!-- Add Users Button -->
                            <div class="col-lg-2 mb-2">
                                <div class="form-group mb-2">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-block user-add-btn"
                                        [disabled]="!isAddButtonEnabled" (click)="addReceiversToTable()">
                                        <i class="ft-user-plus mr-1"></i>
                                        Add Users
                                    </button>
                                </div>
                            </div>

                            <!-- Status Switch -->
                            <div class="col-lg-4 my-auto">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="status"
                                        formControlName="status">
                                    <label class="custom-control-label" for="status">Status</label>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="col-lg-8 mb-2">
                                <label>Description</label>
                                <textarea class="form-control custom-input" rows="3" placeholder="Enter description"
                                    formControlName="Description"></textarea>
                                <div *ngIf="vendorOnboardingForm.get('Description')?.invalid && vendorOnboardingForm.get('Description')?.touched"
                                    class="text-danger small">
                                    Description is required
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
            </div>

            <!-- Selected Receivers Table -->
            <div class="card" *ngIf="receiverRows.length > 0">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="ft-users mr-1"></i>
                        All Request Receivers ({{ receiverRows.length }} users)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <ngx-datatable class="bootstrap table-striped" [rows]="receiverRows" [columns]="receiverColumns"
                            [columnMode]="ColumnMode.force" [headerHeight]="50" [footerHeight]="50" [rowHeight]="'auto'"
                            [limit]="10" [selectionType]="SelectionType.single" [scrollbarH]="false">

                            <!-- User Name Column -->
                            <ngx-datatable-column name="User Name" prop="userName" [width]="200">
                                <ng-template let-value="value" ngx-datatable-cell-template>
                                    <strong>{{ value || 'N/A' }}</strong>
                                </ng-template>
                            </ngx-datatable-column>

                            <!-- Email Column -->
                            <ngx-datatable-column name="Email" prop="email" [width]="250">
                                <ng-template let-value="value" ngx-datatable-cell-template>
                                    {{ value || 'N/A' }}
                                </ng-template>
                            </ngx-datatable-column>

                            <!-- Entity Column -->
                            <ngx-datatable-column name="Entity" prop="entityName" [width]="150">
                            </ngx-datatable-column>    

                            <!-- <ngx-datatable-column name="Entity" prop="entityName" [width]="150">
                                <ng-template let-value="value" ngx-datatable-cell-template>
                                    <span>{{ value || 'N/A' }}</span>
                                </ng-template>
                            </ngx-datatable-column> -->

                            <!-- Role Column -->
                            <ngx-datatable-column name="Role" prop="roleName" [width]="150">
                                <ng-template let-value="value" ngx-datatable-cell-template>
                                    <span class="badge badge-info">{{ value || 'N/A' }}</span>
                                </ng-template>
                            </ngx-datatable-column>

                            <!-- Actions Column -->
                            <ngx-datatable-column name="Actions" [width]="100" [sortable]="false">
                                <ng-template let-row="row" let-rowIndex="rowIndex" ngx-datatable-cell-template>
                                    <button class="btn btn-sm btn-danger" (click)="removeReceiver(row.id)"
                                        title="Remove from List" type="button">
                                        <i class="ft-trash"></i>
                                    </button>
                                </ng-template>
                            </ngx-datatable-column>

                        </ngx-datatable>
                    </div>
                </div>
            </div>

            <!-- Empty State Message -->
            <div class="card" *ngIf="receiverRows.length === 0">
                <div class="card-body text-center py-4">
                    <i class="ft-users text-muted" style="font-size: 48px;"></i>
                    <h5 class="text-muted mt-2">No Receivers Added Yet</h5>

                </div>
            </div>

        </div>
    </div>
</section>